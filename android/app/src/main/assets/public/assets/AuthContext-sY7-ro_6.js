import{r as a,j as v}from"./index-7zqVQZSl.js";import{a as h,P as x,d as c,q as w,w as A,c as p,A as U,z as b,g as y,s as E,Q as D,r as S}from"./auth.client-CflvfX9_.js";const i="Users";function M(r,e){const n=w(p(c,i),A("uid","==",r));return U(n,o=>{if(o.empty)e(null);else{const s=o.docs[0];e({id:s.id,...s.data()})}},o=>{console.error("Error in real-time user fetch:",o),e(null)})}function C(r){const e="SN-",n=r?parseInt(r.replace(e,""),10)+1:1;return`${e}${String(n).padStart(7,"0")}`}async function N(r){try{if(!c)throw new Error("Firestore not initialized");const e=w(p(c,i),b("id","desc")),n=await y(e),t=n.docs.length>0?n.docs[0].id:null,o=C(t),s={...r,id:o};return await E(h(c,i,o),s),s}catch(e){return console.error("Error adding user:",e),null}}async function k(r,e){const n=h(c,i,r);try{await x(c,async t=>{const o=await t.get(n);if(!o.exists())throw new Error("User not found");const s=o.data().overall||{},u={xp:Math.max(0,(s.xp??0)+(e.xp??0)),gems:Math.max(0,(s.gems??0)+(e.gems??0)),life:Math.max(0,(s.life??0)+(e.life??0)),stack:Math.max(0,(s.stack??0)+(e.stack??0)),rank:e.rank??s.rank??"Iron"};t.update(n,{overall:u})})}catch(t){throw console.error("Safe update to overall stats failed:",t),t}}async function P(r,e){const n=h(c,i,r);try{await x(c,async t=>{const o=await t.get(n);if(!o.exists())throw new Error("User not found");const s=o.data().achievements??[];if(s.some(f=>f.ACM_ID===e.ACM_ID)){console.warn("Achievement already exists:",e.ACM_ID);return}const l=[...s,e];t.update(n,{achievements:l})})}catch(t){throw console.error("Failed to add achievement:",t),t}}const g=a.createContext(void 0);function _({children:r}){const[e,n]=a.useState(null),[t,o]=a.useState(null),[s,u]=a.useState(!1),[l,f]=a.useState(!0);return a.useEffect(()=>{if(e!=null&&e.uid){const m=M(e.uid,d=>{d?o(d):n(null)});return()=>m()}},[e]),a.useEffect(()=>D(S,d=>{n(d),f(!1)}),[]),v.jsx(g.Provider,{value:{user:e,UserInfo:t,loading:l,onLogin:s,setOnLogin:u},children:r})}function j(){const r=a.useContext(g);if(!r)throw new Error("useAuth must be used within an AuthProvider");return r}export{_ as A,P as a,N as b,k as p,j as u};
